MessageUnmashaller={SEPARATOR:"|",map:{STOCK:function(b){var a=b.split(MessageUnmashaller.SEPARATOR);if(a.length<59){console.error("StockInfo message structre is change. ");return}itemInfo={};itemInfo.floorCode=a[0];itemInfo.dateNo=a[1];itemInfo.tradingDate=a[2];itemInfo.time=a[3];itemInfo.stockId=a[4];itemInfo.code=a[5];itemInfo.companyName=a[6];itemInfo.stockType=a[7];itemInfo.totalListingQtty=a[8];itemInfo.tradingUnit=a[9];itemInfo.listtingStatus=a[10];itemInfo.adjustQtty=a[11];itemInfo.referenceStatus=a[12];itemInfo.adjustRate=a[13];itemInfo.dividentRate=a[14];itemInfo.status=a[15];itemInfo.totalRoom=a[16];itemInfo.currentRoom=a[17];itemInfo.basicPrice=a[18];itemInfo.openPrice=a[19];itemInfo.closePrice=a[20];itemInfo.currentPrice=a[21];itemInfo.currentQtty=a[22];itemInfo.highestPrice=a[23];itemInfo.lowestPrice=a[24];itemInfo.ceilingPrice=a[25];itemInfo.floorPrice=a[26];itemInfo.totalOfferQtty=a[27];itemInfo.totalBidQtty=a[28];itemInfo.priorPrice=a[29];itemInfo.priorClosePrice=a[30];itemInfo.matchPrice=a[31];itemInfo.matchQtty=a[32];itemInfo.matchValue=a[33];itemInfo.averagePrice=a[34];itemInfo.indexPrice=a[35];itemInfo.bidPrice01=a[36];itemInfo.bidQtty01=a[37];itemInfo.bidPrice02=a[38];itemInfo.bidQtty02=a[39];itemInfo.bidPrice03=a[40];itemInfo.bidQtty03=a[41];itemInfo.offerPrice01=a[42];itemInfo.offerQtty01=a[43];itemInfo.offerPrice02=a[44];itemInfo.offerQtty02=a[45];itemInfo.offerPrice03=a[46];itemInfo.offerQtty03=a[47];itemInfo.prevPriorPrice=a[48];itemInfo.yieldmat=a[49];itemInfo.parvalue=a[50];itemInfo.totalTradingValue=a[51];itemInfo.totalTradingQtty=a[52];itemInfo.accumulatedVal=a[53];itemInfo.accumulatedVol=a[54];itemInfo.buyForeignValue=a[55];itemInfo.sellForeignValue=a[56];itemInfo.buyForeignQtty=a[57];itemInfo.sellForeignQtty=a[58];itemInfo.projectOpen=a[59];itemInfo.sequence=a[60];return itemInfo},MARKETINFO:function(b){var a=b.split(MessageUnmashaller.SEPARATOR);itemInfo={};itemInfo.marketID=a[0];itemInfo.totalTrade=a[1];itemInfo.totalShareTraded=a[2];itemInfo.totalValueTraded=a[3];itemInfo.advance=a[4];itemInfo.decline=a[5];itemInfo.noChange=a[6];itemInfo.indexValue=a[7];itemInfo.changed=a[8];itemInfo.tradingTime=a[9];itemInfo.tradingDate=a[10];itemInfo.floorCode=a[11];itemInfo.marketIndex=a[12];itemInfo.priorMarketIndex=a[13];itemInfo.highestIndex=a[14];itemInfo.lowestIndex=a[15];itemInfo.shareTraded=a[16];itemInfo.status=a[17];itemInfo.sequence=a[18];return itemInfo},PT_ORDER:function(b){var a=b.split(MessageUnmashaller.SEPARATOR);itemInfo={};itemInfo.floorCode=a[0];itemInfo.symbol=a[1];itemInfo.price=parseFloat(a[2]);itemInfo.volume=parseFloat(a[3]);itemInfo.time=a[4];itemInfo.sequence=a[5];itemInfo.basicPrice=a[6];return itemInfo},AD_ORDER:function(b){var a=b.split(MessageUnmashaller.SEPARATOR);itemInfo={};itemInfo.floorCode=a[0];itemInfo.stockSymbol=a[1];itemInfo.price=a[2];itemInfo.vol=a[3];itemInfo.type=a[4];itemInfo.status=a[5];itemInfo.time=a[6];itemInfo.sequence=a[7];itemInfo.basicPrice=a[8];itemInfo.ceilingPrice=a[9];itemInfo.floorPrice=a[10];return itemInfo},TRANSACTION:function(b){var a=b.split(MessageUnmashaller.SEPARATOR);itemInfo={};itemInfo.floorCode=a[0];itemInfo.symbol=a[1];itemInfo.highest=a[2];itemInfo.last=a[3];itemInfo.lastVol=a[4];itemInfo.lowest=a[5];itemInfo.matchType=a[6];itemInfo.openPrice=a[7];itemInfo.time=a[8];itemInfo.sequence=a[9];itemInfo.basicPrice=a[10];itemInfo.ceilingPrice=a[11];itemInfo.floorPrice=a[11];return itemInfo}},regist:function(b,a){if(typeof a=="function"){this.map[b]=a}},unmashall:function(a,b){if(typeof this.map[a]=="undefined"){console.log("Has no unmashaller for mess type: "+a);return b}return this.map[a](b)}};
function ConsumerManager(){this.init()}ConsumerManager.prototype={init:function(){this.crrCodesList={}},regist:function(d,b){var e=this.crrCodesList[d];if(!e){this.crrCodesList[d]=b;return b}var a=ArrayUtil.getChangeArr(b,e);for(var c=0;c<a.length;c++){e.push(a[c])}return e},stop:function(e,b){var f=this.crrCodesList[e];if(!f){return[]}var a=[];for(var d=0;d<b.length;d++){var c=f.indexOf(b[d]);if(c>=0){f.splice(c,1);a.push(b[d])}}return a}};
function ServerProvider(a){this.serverList=a?a:Config.socket.serverList}ServerProvider.prototype={crrServerIndex:0,getRandomServer:function(){var a=Math.round(Math.random()*100)%this.serverList.length;this.crrServerIndex=a;return this.serverList[a]},getCrrServer:function(){return this.serverList[this.crrServerIndex]},getNextServer:function(){this.crrServerIndex=(this.crrServerIndex+1)%this.serverList.length;return this.getCrrServer()},add:function(a){this.serverList.push(a)},getSockjsRandomServer:function(){return this.getRandomServer()+"realtime"},getSockJSNextServer:function(){return this.getNextServer()+"realtime"},getAjaxRandomServer:function(){return this.getRandomServer()},getAjaxNextServer:function(){return this.getNextServer()}};SockJS.prototype.handler={};SockJS.prototype.on=function(a,b){this.handler[a]=b};SockJS.prototype.onmessage=function(a){var b=JSON.parse(a.data);if(typeof(this.handler[b.type])=="function"){this.handler[b.type](b.type,b.data)}};SockJS.prototype.emit=function(a,b){var c=JSON.stringify({type:a,data:b});this.send(c)};function SocketManager(b,a){this.serverProvider=b;this.options=a;this.consumerManager=new ConsumerManager()}SocketManager.prototype={options:{},hasConnect:false,state:"",eventPool:[],eventList:["STOCK","MARKETINFO","TRANSACTION","PUT","PUTEXEC"],crrSequence:0,crrActiveSequence:0,start:function(){this.jqueryOb=$(this);this.createConnect(this.serverProvider.getSockjsRandomServer())},createConnect:function(a){console.log(a);this.socket=new SockJS(a);this.socket.onopen=function(){console.log("connected");if(this.hasConnect){this.setState("resume")}else{this.setState("init");this.hasConnect=true}this.listenServerEvent();this.consumeAfterConnect()}.bind(this);this.socket.onclose=function(){this.setState("pause")}.bind(this)},listenServerEvent:function(){this.socket.on("returnFull",function(c,d){this.emit("receiveFullData",d)}.bind(this));this.socket.on("returnData",function(c,d){this.emit("returnData",d)}.bind(this));this.socket.on("finishStop",function(c,d){if(d==DataEventType.STOCK){this.registCrrCodes(DataEventType.STOCK)}}.bind(this));for(var b=0;b<this.eventList.length;b++){var a=this.eventList[b]+"";this.socket.on(a,function(d,e){var c=MessageUnmashaller.unmashall(d,e);this.handleDataEvent(d,c)}.bind(this))}},active:function(){this.setState("ready")},reconnect:function(){setTimeout(function(){this.createConnect(this.serverProvider.getSockJSNextServer())}.bind(this),Config.reconnectDelayTime)},handleDataEvent:function(a,b){this.setSequence(b.sequence);this.emit(a,b)},releasePoolEvent:function(){for(var a=0;a<this.eventPool.length;a++){var b=this.eventPool[a];this.emit(b.eventName,b.data)}},setSequence:function(a){if(this.crrSequence>=a){return false}this.crrSequence=a;return true},requestFullData:function(a){this.socket.emit("requestFullData",{sequence:this.crrSequence,params:a})},postData:function(a){this.socket.emit("post",{sequence:this.crrSequence,params:a})},setState:function(a){this.state=a;switch(a){case"init":this.sendHeartbeat();break;case"active":break;case"ready":this.releasePoolEvent();this.setState("active");break;case"pause":this.reconnect();break;case"resume":this.socket.emit("resumne",{sequence:this.crrSequence});this.setState("active");break}this.emit(a,{})},test:function(a){this.socket.emit("loadTest",{sequence:this.crrSequence,data:a})},regisEvent:function(a){this.eventList=a},registConsumer:function(b){if(this.eventList.indexOf(b.type)==-1){this.eventList.push(b.type)}var a=this.consumerManager.regist(b.type,b.codes);try{if(this.state!=""&&this.state!="pause"){this.socket.emit("registConsumer",{sequence:this.crrSequence,params:{name:b.type,codes:a}})}}catch(c){}},consumeAfterConnect:function(){var c=Object.keys(this.consumerManager.crrCodesList);if(!c){return}for(var b=0;b<c.length;b++){var a=this.consumerManager.crrCodesList[c[b]];this.socket.emit("registConsumer",{sequence:this.crrSequence,params:{name:c[b],codes:a}})}},sendHeartbeat:function(){setInterval(function(){this.registCrrCodes(DataEventType.STOCK)}.bind(this),5*60*1000)},registCrrCodes:function(){var a=this.consumerManager.crrCodesList[DataEventType.STOCK];this.socket.emit("registConsumer",{sequence:this.crrSequence,params:{name:DataEventType.STOCK,codes:a},isIntervalRegist:true})},stopConsume:function(b){var a=this.consumerManager.stop(b.type,b.codes);try{if(this.state!=""&&this.state!="pause"){this.socket.emit("stopConsume",{sequence:this.crrSequence,params:{name:b.type,codes:a}})}}catch(c){}},emit:function(b,a){this.jqueryOb.trigger({type:b,message:a,time:new Date()})},on:function(b,a){$(this).bind(b,a)}};DataEventType={STOCK:"STOCK",AD_ORDER:"AD_ORDER",PT_ORDER:"PT_ORDER",MARKETINFO:"MARKETINFO",TRANSACTION:"TRANSACTION",CATEGORY:"CATEGORY",MARKET_BEGIN:"MARKET_BEGIN",MARKET_END:"MARKET_END",MARKET_END_RECOVERY:"MARKET_END_RECOVERY"};
ArrayUtil={getChangeArr:function(d,c){var b=[];for(var a=0;a<d.length;a++){if(c.indexOf(d[a])<0){b.push(d[a])}}return b},orArr:function(c,b){var a=[];var e=this.getChangeArr(c,b);for(var d=0;d<e.length;d++){a.push(e[d])}for(var d=0;d<b.length;d++){a.push(b[d])}return a},andArr:function(b,a){var d=[];for(var c=0;c<b.length;c++){if(a.indexOf(b[c])>=0){d.push(b[c])}}return d},getArrFromMap:function(d){var a=[];var c=Object.keys(d);for(var b=0;b<c.length;b++){a.push(d[c[b]])}return a}};
